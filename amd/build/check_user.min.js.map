{"version":3,"file":"check_user.min.js","sources":["../src/check_user.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\ndefine(['jquery', 'core/log', 'core/config', 'core/str', 'core/icon_system_standard'], function($, log, cfg, str, icons) {\n\n    var user_delegation_check = {\n\n        strs: [],\n\n        init: function() {\n            $('#id_submitbutton').bind('click', this.check_user);\n\n            // Fetch some strings.\n            str.get_strings([{\n                key: 'validatinguser',\n                component: 'block_user_delegation'\n            }, {\n                key: 'uservalid',\n                component: 'block_user_delegation'\n            }, {\n                key: 'userexists',\n                component: 'block_user_delegation'\n            }, {\n                key: 'checkuserinvite',\n                component: 'block_user_delegation'\n            }, {\n                key: 'attachtome',\n                component: 'block_user_delegation'\n            }, {\n                key: 'useradded',\n                component: 'block_user_delegation'\n            }\n            ]).then(function(results) {\n                this.strs['validatinguser'] = results[0];\n                this.strs['uservalid'] = results[1];\n                this.strs['userexists'] = results[2];\n                this.strs['checkuserinvite'] = results[3];\n                this.strs['atachtome'] = results[4];\n                this.strs['useradded'] = results[5];\n            });\n        },\n\n        check_user: function(e) {\n\n            var that = $(this);\n            e.preventDefault();\n\n            var uid = $('#id').val();\n            var userform = that.closest('form');\n\n            if (uid != -1) {\n                // Submit the form.\n                userform.submit();\n            } else {\n                $(this).val(user_delegation_check.strs['validatinguser'] + '.');\n                var email = $('#id_email').val();\n                var firstname = $('#id_firstname').val();\n                var lastname = $('#id_lastname').val();\n                user_delegation_check.check_user_exist(email,firstname,lastname, userform);\n            }\n        },\n\n        /**\n         * Checks if a user exists and propose attachement options.\n         * @param {String} email\n         * @param {String} firstname\n         * @param {String} lastname\n         * @param {String} userform\n         */\n        check_user_exist: function(email, firstname, lastname, userform) {\n\n            var skey = $('input[name=sesskey]').val();\n\n            var checkurl = cfg.wwwroot + '/blocks/user_delegation/serverside/service.php';\n            var params = {\n                    action: 'CheckUserExist',\n                    sesskey: skey,\n                    f_name: firstname,\n                    l_name: lastname,\n                    e: email\n            };\n\n            $.getJSON(checkurl, params, function(data) {\n\n                if (data.result == 0) {\n                    // User is not colliding with an exiting user.\n                    $('#id_submitbutton').val(user_delegation_check.strs['uservalid']);\n                    userform.submit();\n                } else {\n                    // User IS colliding with an exiting user.\n                    $('#id_submitbutton').val(user_delegation_check.strs['userexists']);\n\n                    $.each(data.users, function(i, obj) {\n                        $('#existing_users').append('<div>' +\n                            user_delegation_check.strs['usercheckinvite'] + '</div>');\n\n                        $('#existing_users').append(\n                            '<div class=\"info-exist-user-cont\">' +\n                            icons.renderIcon('user', 'block_user_delegation', '', 'core/pix_icon') +\n                            obj.firstname + \" \" + obj.lastname +\n                            '&nbsp;&nbsp;&nbsp;&nbsp;' +\n                            '<a class=\"addtoaccount\" uid=\"' + obj.id + '\" href=\"#\"> '+\n                                user_delegation_check.strs['attachtome'] + '</a>' +\n                            '</div>'\n                        );\n                    });\n\n                    $(\"#existing_users a\").live(\"click\", function(event) {\n                        event.preventDefault();\n                        var power_uid = $('input[name=power_uid]').val();\n                        var fellow_uid = $(this).attr('uid');\n                        var params = {\n                                action: 'AttachUser',\n                                sesskey: skey,\n                                puid: power_uid,\n                                fuid: fellow_uid\n                        };\n                        $.getJSON(checkurl, params, function(data) {\n                                if (data.result == 1) {\n                                    alert(user_delegation_check.strs['useradded']);\n                                    window.location = cfg.wwwroot +\n                                        \"/block/userdelegation/myusers.php?course=\" +\n                                            $('input[name=course]').val();\n                                }\n                            });\n                        });\n\n                    $('#existing_users').show();\n                }\n\n            });\n        },\n    }; // End of user_delegation_check;\n\n    return user_delegation_check;\n\n});\n"],"names":["define","$","log","cfg","str","icons","user_delegation_check","strs","init","bind","this","check_user","get_strings","key","component","then","results","e","that","preventDefault","uid","val","userform","closest","submit","email","firstname","lastname","check_user_exist","skey","checkurl","wwwroot","params","action","sesskey","f_name","l_name","getJSON","data","result","each","users","i","obj","append","renderIcon","id","live","event","power_uid","fellow_uid","attr","puid","fuid","alert","window","location","show"],"mappings":"AAeAA,0CAAO,CAAC,SAAU,WAAY,cAAe,WAAY,8BAA8B,SAASC,EAAGC,IAAKC,IAAKC,IAAKC,WAE1GC,sBAAwB,CAExBC,KAAM,GAENC,KAAM,WACFP,EAAE,oBAAoBQ,KAAK,QAASC,KAAKC,YAGzCP,IAAIQ,YAAY,CAAC,CACbC,IAAK,iBACLC,UAAW,yBACZ,CACCD,IAAK,YACLC,UAAW,yBACZ,CACCD,IAAK,aACLC,UAAW,yBACZ,CACCD,IAAK,kBACLC,UAAW,yBACZ,CACCD,IAAK,aACLC,UAAW,yBACZ,CACCD,IAAK,YACLC,UAAW,2BAEZC,MAAK,SAASC,cACRT,KAAL,eAA8BS,QAAQ,QACjCT,KAAL,UAAyBS,QAAQ,QAC5BT,KAAL,WAA0BS,QAAQ,QAC7BT,KAAL,gBAA+BS,QAAQ,QAClCT,KAAL,UAAyBS,QAAQ,QAC5BT,KAAL,UAAyBS,QAAQ,OAIzCL,WAAY,SAASM,OAEbC,KAAOjB,EAAES,MACbO,EAAEE,qBAEEC,IAAMnB,EAAE,OAAOoB,MACfC,SAAWJ,KAAKK,QAAQ,YAEhB,GAARH,IAEAE,SAASE,aACN,CACHvB,EAAES,MAAMW,IAAIf,sBAAsBC,KAAtB,eAA+C,SACvDkB,MAAQxB,EAAE,aAAaoB,MACvBK,UAAYzB,EAAE,iBAAiBoB,MAC/BM,SAAW1B,EAAE,gBAAgBoB,MACjCf,sBAAsBsB,iBAAiBH,MAAMC,UAAUC,SAAUL,YAWzEM,iBAAkB,SAASH,MAAOC,UAAWC,SAAUL,cAE/CO,KAAO5B,EAAE,uBAAuBoB,MAEhCS,SAAW3B,IAAI4B,QAAU,iDACzBC,OAAS,CACLC,OAAQ,iBACRC,QAASL,KACTM,OAAQT,UACRU,OAAQT,SACRV,EAAGQ,OAGXxB,EAAEoC,QAAQP,SAAUE,QAAQ,SAASM,MAEd,GAAfA,KAAKC,QAELtC,EAAE,oBAAoBoB,IAAIf,sBAAsBC,KAAtB,WAC1Be,SAASE,WAGTvB,EAAE,oBAAoBoB,IAAIf,sBAAsBC,KAAtB,YAE1BN,EAAEuC,KAAKF,KAAKG,OAAO,SAASC,EAAGC,KAC3B1C,EAAE,mBAAmB2C,OAAO,QACxBtC,sBAAsBC,KAAtB,gBAAgD,UAEpDN,EAAE,mBAAmB2C,OACjB,qCACAvC,MAAMwC,WAAW,OAAQ,wBAAyB,GAAI,iBACtDF,IAAIjB,UAAY,IAAMiB,IAAIhB,SAF1B,wDAIkCgB,IAAIG,GAAK,eACvCxC,sBAAsBC,KAAtB,WALJ,iBAURN,EAAE,qBAAqB8C,KAAK,SAAS,SAASC,OAC1CA,MAAM7B,qBACF8B,UAAYhD,EAAE,yBAAyBoB,MACvC6B,WAAajD,EAAES,MAAMyC,KAAK,OAC1BnB,OAAS,CACLC,OAAQ,aACRC,QAASL,KACTuB,KAAMH,UACNI,KAAMH,YAEdjD,EAAEoC,QAAQP,SAAUE,QAAQ,SAASM,MACV,GAAfA,KAAKC,SACLe,MAAMhD,sBAAsBC,KAAtB,WACNgD,OAAOC,SAAWrD,IAAI4B,QAClB,4CACI9B,EAAE,sBAAsBoB,aAKhDpB,EAAE,mBAAmBwD,oBAO9BnD"}